<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>berozgaars...</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Italianno&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      xintegrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .bg-primary {
        background-color: #a7f3d0;
      }
      .bg-secondary {
        background-color: #14b8a6;
      }
      .text-primary {
        color: #047857;
      }
      .text-secondary {
        color: #0d9488;
      }
      .border-primary {
        border-color: #047857;
      }
      .border-secondary {
        border-color: #14b8a6;
      }
      .btn-primary {
        background-color: #14b8a6;
        color: white;
        transition: background-color 0.3s;
      }
      .btn-primary:hover {
        background-color: #0d9488;
      }
      .btn-primary:disabled {
        background-color: #5eead4;
        cursor: not-allowed;
      }
      .btn-secondary {
        background-color: #a7f3d0;
        color: #047857;
        transition: background-color 0.3s;
      }
      .btn-secondary:hover {
        background-color: #6ee7b7;
      }
      .nav-item.active {
        color: #14b8a6;
      } /* No underline */
      .my-jobs-tab-item.active {
        color: #047857;
        border-bottom: 2px solid #047857;
      }
      .tab-item.active {
        color: #14b8a6;
      } /* No underline */
      .page,
      .tab-content {
        display: none;
      }
      .page.active,
      .tab-content.active {
        display: block;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #14b8a6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
      }
      .modal-content {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }
      .auth-page {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 2rem;
      }
      .passion-btn {
        background-color: #e6fffa;
        color: #0d9488;
        border: 1px solid #a7f3d0;
      }
      .passion-btn.selected {
        background-color: #14b8a6;
        color: white;
        border-color: #0d9488;
      }
      #messages-page,
      #chat-view-container {
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      /* Splash Screen Styles */
      #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #0d9488; /* Darker Teal for better contrast */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.5s ease-out;
      }
      .splash-logo {
        font-family: "Italianno", cursive;
        font-size: 5rem; /* Made bigger */
        color: #a7f3d0; /* Light Green */
        font-weight: 400;
      }
      .splash-logo span {
        opacity: 0;
        display: inline-block;
        transform: translateY(20px);
        animation: fadeInUp 0.5s ease-out forwards;
      }
      @keyframes fadeInUp {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Read Receipt Ticks */
      .ticks {
        color: #a0aec0; /* gray-500 */
        font-size: 0.8rem;
      }
      .ticks.read {
        color: #4fd1c5; /* teal-400 */
      }
      /* In-App Browser Styles */
      .in-app-browser-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        z-index: 1001;
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
      }
      .in-app-browser-overlay.open {
        transform: translateY(0);
      }
      .in-app-browser-header {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border-bottom: 1px solid #e2e8f0;
      }
      .in-app-browser-iframe {
        width: 100%;
        height: calc(100% - 57px); /* Full height minus header */
        border: none;
      }
      /* Hide scrollbar for a cleaner 'app' look */
      ::-webkit-scrollbar {
        display: none;
      }
      body, .modal-content, #chat-body, #main-content {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      /* Premium Button Styles */
      .premium-btn {
          background: linear-gradient(to right, #FBBF24, #F59E0B);
          color: white;
          box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
          transition: transform 0.2s, box-shadow 0.2s;
      }
      .premium-btn:hover {
          transform: scale(1.05);
          box-shadow: 0 6px 16px rgba(251, 191, 36, 0.5);
      }
      .plan-card {
        border: 2px solid #e5e7eb;
        transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
      }
      .plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      }
      .plan-card.selected {
        border-color: #14b8a6;
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.3);
      }
      .payment-tab.active {
        background-color: #14b8a6;
        color: white;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <!-- Splash Screen -->
    <div id="splash-screen">
      <h1 id="splash-logo-text" class="splash-logo"></h1>
    </div>

    <div id="app-wrapper">
      <!-- This wrapper will contain either the auth flow or the main app -->
    </div>

    <!-- Modals Container -->
    <div id="modals-container"></div>

    <script>
      // --- MOCK DATABASE & STATE ---
      let currentUser = null;
      let userSearchHistory = [];
      let userResume = {
        file: null,
        fileName: null,
        text: "Rohan Sharma - Aspiring Software Developer. Skills: Java, Python, SQL, JavaScript. Projects: Built a college event management website.",
        linkedin: "",
        skills: [],
      };
      let userJobPreferences = [];
      let userAppliedJobs = [1, 8]; // IDs of jobs already applied to
      let userSavedJobs = [2, 5, 10]; // IDs of jobs saved
      let userInterviewJobs = [4]; // IDs of jobs with interviews

      const jobCategories = [
        "Tech",
        "Marketing",
        "Design",
        "Finance",
        "Engineering",
        "Sales",
        "HR",
      ];

      let userPortfolios = [
        { title: "My Personal Blog", url: "https://example.blog.com" },
        { title: "GitHub Profile", url: "https://github.com/rohansharma" },
      ];

      let userRecommendations = {
        received: [
          {
            from: "Priya Patel",
            relationship: "Managed Rohan directly at Tech Solutions Inc.",
            text: "Rohan is a highly motivated and fast-learning intern. His contributions to our flagship project were invaluable. He has a keen eye for detail and is always ready to take on new challenges. Any team would be lucky to have him.",
            status: "approved",
          },
          {
            from: "Professor Verma",
            relationship:
              "Rohan was a student in my Advanced Algorithms course.",
            text: "Rohan was one of the top performers in my class. He demonstrated a deep understanding of complex data structures and always submitted exemplary work. He has a bright future in software engineering.",
            status: "pending",
          },
        ],
        given: [
          {
            to: "Aisha Khan",
            relationship: "Worked with Aisha on a university project",
            text: "Aisha is an exceptional team player and a brilliant coder. Her ability to solve complex problems under pressure was a great asset to our team. I highly recommend her.",
          },
        ],
      };

      const conversations = [
        {
          id: 1,
          company: "TCS",
          jobTitle: "Software Engineer Role",
          unread: true,
          chat: [
            {
              sender: "company",
              text: "Dear Rohan, Thank you for your application. We were impressed with your profile and would like to invite you for a virtual interview on July 5th at 11:00 AM. Please confirm your availability. Regards, TCS HR.",
              timestamp: "9:30 AM",
            },
          ],
        },
        {
          id: 2,
          company: "Accenture",
          jobTitle: "Data Analyst Application",
          unread: false,
          chat: [
            {
              sender: "company",
              text: "Dear Applicant, We have received your application for the Data Analyst position. Our team is currently reviewing profiles and we will get back to you shortly.",
              timestamp: "Yesterday",
            },
            {
              sender: "company",
              text: "Thank you for your interest in Accenture.",
              timestamp: "Yesterday",
            },
          ],
        },
        {
          id: 3,
          company: "Social Buzz",
          jobTitle: "Offer of Internship - Digital Marketing",
          unread: false,
          chat: [
            {
              sender: "company",
              text: "Congratulations! We are pleased to offer you the position of Digital Marketing Intern at Social Buzz. Please find the detailed offer letter attached. We look forward to you joining our team!",
              timestamp: "June 28",
            },
            {
              sender: "user",
              text: "Thank you so much! I am thrilled to accept the offer. I will go through the offer letter and get back to you soon.",
              timestamp: "June 28",
              status: "read",
            },
          ],
        },
      ];

      const indianCities = [
        "Mumbai",
        "Delhi",
        "Bengaluru",
        "Hyderabad",
        "Ahmedabad",
        "Chennai",
        "Kolkata",
        "Surat",
        "Pune",
        "Jaipur",
        "Lucknow",
        "Kanpur",
        "Nagpur",
        "Indore",
        "Thane",
        "Bhopal",
        "Visakhapatnam",
        "Patna",
        "Vadodara",
        "Ghaziabad",
        "Ludhiana",
        "Agra",
        "Nashik",
        "Faridabad",
        "Meerut",
        "Rajkot",
        "Varanasi",
        "Srinagar",
        "Aurangabad",
        "Dhanbad",
        "Amritsar",
        "Allahabad",
        "Ranchi",
        "Howrah",
        "Coimbatore",
        "Jabalpur",
        "Gwalior",
        "Vijayawada",
        "Jodhpur",
        "Madurai",
        "Raipur",
        "Kota",
        "Guwahati",
        "Chandigarh",
      ];

      let allJobs = [
        {
          id: 1,
          title: "Entry Level Software Engineer",
          company: "TCS",
          location: "Bengaluru",
          salary: "₹4.5 LPA",
          type: "Full-time",
          source: "Naukri",
          applyType: "external",
          applyLink: "https://www.naukri.com",
          details: {
            description:
              "Seeking motivated software engineers to develop and maintain high-quality software products.",
            responsibilities: [
              "Write clean, scalable code",
              "Test and deploy applications",
              "Collaborate with teams",
            ],
            skills: ["Java", "Python", "SQL", "Git"],
          },
        },
        {
          id: 2,
          title: "Digital Marketing Intern",
          company: "Social Buzz",
          location: "Mumbai",
          salary: "₹15,000/month",
          type: "Internship",
          source: "Internshala",
          applyType: "external",
          applyLink: "https://internshala.com",
          details: {
            description:
              "Join our marketing team to create engaging online campaigns.",
            responsibilities: [
              "Manage social media accounts",
              "Create content calendars",
              "Analyze campaign performance",
            ],
            skills: ["SEO", "SEM", "Content Writing", "Canva"],
          },
        },
        {
          id: 3,
          title: "Graduate Engineer Trainee",
          company: "L&T Construction",
          location: "Chennai",
          salary: "₹6 LPA",
          type: "Full-time",
          source: "LinkedIn",
          applyType: "external",
          applyLink: "https://linkedin.com",
          details: {
            description:
              "A training program for civil engineering graduates to work on large-scale infrastructure projects.",
            responsibilities: [
              "Site management",
              "Project planning",
              "Quality control",
            ],
            skills: ["AutoCAD", "Civil Engineering", "Project Management"],
          },
        },
        {
          id: 4,
          title: "Data Analyst Fresher",
          company: "Accenture",
          location: "Hyderabad",
          salary: "₹4 LPA",
          type: "Full-time",
          source: "Indeed",
          applyType: "external",
          applyLink: "https://indeed.com",
          details: {
            description:
              "Analyze large datasets to provide actionable insights for our clients.",
            responsibilities: [
              "Data cleaning and processing",
              "Creating dashboards and reports",
              "Statistical analysis",
            ],
            skills: ["Excel", "SQL", "Power BI", "Python"],
          },
        },
        {
          id: 5,
          title: "Graphic Design Fresher",
          company: "Design Co.",
          location: "Pune",
          salary: "₹3.5 LPA",
          type: "Full-time",
          source: "Berozgaars",
          applyType: "native",
          applyLink: "#",
          details: {
            description:
              "Create visually stunning graphics for web, mobile, and print.",
            responsibilities: [
              "Designing logos and banners",
              "Creating marketing materials",
              "Collaborating with the marketing team",
            ],
            skills: ["Adobe Photoshop", "Illustrator", "Figma"],
          },
        },
        {
          id: 6,
          title: "Business Development Executive (Sales)",
          company: "Growthify",
          location: "Delhi",
          salary: "₹4 LPA + Incentives",
          type: "Full-time",
          source: "Naukri",
          applyType: "external",
          applyLink: "https://naukri.com",
          details: {
            description:
              "Drive business growth by identifying and acquiring new clients.",
            responsibilities: [
              "Lead generation",
              "Client presentations",
              "Negotiating contracts",
            ],
            skills: ["Communication", "Sales", "CRM"],
          },
        },
        {
          id: 7,
          title: "Associate Software Developer",
          company: "Infosys",
          location: "Pune",
          salary: "₹4.2 LPA",
          type: "Full-time",
          source: "Berozgaars",
          applyType: "native",
          applyLink: "#",
          details: {
            description:
              "Be part of a team that designs, develops and supports activities for software applications.",
            responsibilities: [
              "Coding and debugging",
              "Software lifecycle management",
              "Working in an Agile team",
            ],
            skills: ["C#", ".NET", "Cloud Basics"],
          },
        },
        {
          id: 8,
          title: "Human Resources (HR) Intern",
          company: "PeopleFirst HR",
          location: "Gurugram",
          salary: "₹12,000/month",
          type: "Internship",
          source: "Internshala",
          applyType: "external",
          applyLink: "https://internshala.com",
          details: {
            description: "Assist with daily HR functions and duties.",
            responsibilities: [
              "Recruitment support",
              "Onboarding new hires",
              "Maintaining employee records",
            ],
            skills: ["MS Office", "Communication", "HR Principles"],
          },
        },
        {
          id: 9,
          title: "Financial Analyst - Entry Level",
          company: "Goldman Sachs",
          location: "Bengaluru",
          salary: "Competitive",
          type: "Full-time",
          source: "Careers",
          applyType: "external",
          applyLink: "https://www.goldmansachs.com/careers/",
          details: {
            description:
              "Provide analytical support for investment banking activities.",
            responsibilities: [
              "Financial modeling",
              "Market research",
              "Preparing presentations",
            ],
            skills: ["Finance", "Excel", "Valuation"],
          },
        },
        {
          id: 10,
          title: "UI/UX Design Intern",
          company: "PixelPerfect",
          location: "Remote",
          salary: "₹18,000/month",
          type: "Internship",
          source: "Berozgaars",
          applyType: "native",
          applyLink: "#",
          details: {
            description:
              "Help create intuitive and beautiful user interfaces for our mobile apps.",
            responsibilities: [
              "Wireframing and prototyping",
              "User research",
              "Creating design systems",
            ],
            skills: ["Figma", "UI/UX", "Prototyping"],
          },
        },
        {
          id: 11,
          title: "Mechanical Engineer Fresher",
          company: "Tata Motors",
          location: "Pune",
          salary: "₹5.5 LPA",
          type: "Full-time",
          source: "Careers",
          applyType: "external",
          applyLink: "https://www.tatamotors.com/careers/",
          details: {
            description: "Join our automotive design and manufacturing team.",
            responsibilities: [
              "CAD modeling",
              "Product testing",
              "Process improvement",
            ],
            skills: ["SolidWorks", "CATIA", "Mechanical Engineering"],
          },
        },
        {
          id: 12,
          title: "Content Writer (Fresher)",
          company: "WriteRight",
          location: "Kolkata",
          salary: "₹2.5 LPA",
          type: "Full-time",
          source: "Indeed",
          applyType: "external",
          applyLink: "https://indeed.com",
          details: {
            description:
              "Create compelling blog posts, articles, and social media content.",
            responsibilities: [
              "Researching industry topics",
              "Writing clear marketing copy",
              "Proofreading and editing",
            ],
            skills: ["English Proficiency", "Content Writing", "SEO"],
          },
        },
      ];

      // --- INITIALIZATION ---
      window.onload = () => {
        // Animate splash screen text
        const logoText = document.getElementById("splash-logo-text");
        const text = "berozgaars";
        text.split("").forEach((char, index) => {
          const span = document.createElement("span");
          span.textContent = char;
          span.style.animationDelay = `${index * 0.15}s`;
          logoText.appendChild(span);
        });

        // Show animation, then decide what to render.
        setTimeout(() => {
          const splash = document.getElementById("splash-screen");
          splash.style.opacity = "0";
          setTimeout(() => {
            splash.style.display = "none";
            // Check for logged-in user AFTER splash screen
            if (localStorage.getItem("currentUser")) {
              currentUser = JSON.parse(localStorage.getItem("currentUser"));
              userJobPreferences =
                JSON.parse(localStorage.getItem("userJobPreferences")) || [];
              renderMainApp();
            } else {
              renderAuthFlow();
            }
          }, 500); // Wait for fade out to finish
        }, 2000); // Reduced splash screen time

        requestLocationPermission();
      };

      // --- AUTHENTICATION FLOW ---
      function renderAuthFlow() {
        const appWrapper = document.getElementById("app-wrapper");
        appWrapper.innerHTML = `<div id="auth-container" class="max-w-md mx-auto bg-white"></div>`;
        renderLoginPage();
      }
      function renderLoginPage() {
        const authContainer = document.getElementById("auth-container");
        authContainer.innerHTML = `<div class="auth-page"><h1 class="text-4xl font-bold text-primary mb-2" style="font-family: 'Italianno', cursive;">berozgaars</h1><p class="text-gray-600 mb-8">Find your first job, today.</p><form id="login-form" class="w-full"><div class="mb-4"><label class="block text-gray-700">Email</label><input type="email" id="login-email" class="w-full p-3 border rounded-lg" required value="rohan.sharma@example.com"></div><div class="mb-6"><label class="block text-gray-700">Password</label><input type="password" id="login-password" class="w-full p-3 border rounded-lg" required value="password"></div><button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg mb-4">Login</button><p class="text-center">Don't have an account? <a href="#" id="show-signup" class="text-secondary font-semibold">Sign Up</a></p></form></div>`;
        document
          .getElementById("login-form")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("show-signup")
          .addEventListener("click", (e) => {
            e.preventDefault();
            renderSignupPage();
          });
      }
      function renderSignupPage() {
        const authContainer = document.getElementById("auth-container");
        authContainer.innerHTML = `<div class="auth-page"><h1 class="text-3xl font-bold text-primary mb-6">Create Account</h1><form id="signup-form" class="w-full"><div class="mb-4"><label class="block text-gray-700">Full Name</label><input type="text" id="signup-name" class="w-full p-3 border rounded-lg" required></div><div class="mb-4"><label class="block text-gray-700">Email</label><input type="email" id="signup-email" class="w-full p-3 border rounded-lg" required></div><div class="mb-6"><label class="block text-gray-700">Password</label><input type="password" id="signup-password" class="w-full p-3 border rounded-lg" required></div><button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg mb-4">Sign Up</button><p class="text-center">Already have an account? <a href="#" id="show-login" class="text-secondary font-semibold">Login</a></p></form></div>`;
        document
          .getElementById("signup-form")
          .addEventListener("submit", handleSignup);
        document.getElementById("show-login").addEventListener("click", (e) => {
          e.preventDefault();
          renderLoginPage();
        });
      }
      function handleLogin(e) {
        e.preventDefault();
        const name = document
          .getElementById("login-email")
          .value.split("@")[0]
          .replace(".", " ")
          .replace(/\b\w/g, (l) => l.toUpperCase());
        currentUser = {
          name: name || "Rohan Sharma",
          email: document.getElementById("login-email").value,
          isPremium: false,
        };
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        renderMainApp();
      }
      function handleSignup(e) {
        e.preventDefault();
        currentUser = {
          name: document.getElementById("signup-name").value,
          email: document.getElementById("signup-email").value,
          isPremium: false,
        };
        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        renderMainApp();
      }
      function handleLogout() {
        currentUser = null;
        userJobPreferences = [];
        localStorage.clear();
        renderAuthFlow();
      }

      // --- MAIN APPLICATION ---
      function renderMainApp() {
        const appWrapper = document.getElementById("app-wrapper");
        appWrapper.innerHTML = `
                <div id="app-container" class="max-w-md mx-auto bg-white shadow-lg overflow-hidden min-h-screen flex flex-col">
                    <main id="main-content" class="flex-grow pb-20 overflow-y-auto">
                        <!-- Pages will be rendered here by the router -->
                    </main>
                    <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t flex justify-around">
                        <a href="#home" data-page="home-page" class="nav-item active flex-1 text-center py-3"><i class="fas fa-home"></i><span class="block text-xs">Home</span></a>
                        <a href="#my-jobs" data-page="my-jobs-page" class="nav-item flex-1 text-center py-3 text-gray-500"><i class="fas fa-bookmark"></i><span class="block text-xs">My Jobs</span></a>
                        <a href="#messages" data-page="messages-page" class="nav-item flex-1 text-center py-3 text-gray-500"><i class="fas fa-comment-dots"></i><span class="block text-xs">Messages</span></a>
                        <a href="#profile" data-page="profile-page" class="nav-item flex-1 text-center py-3 text-gray-500"><i class="fas fa-user"></i><span class="block text-xs">Profile</span></a>
                    </nav>
                </div>
            `;
        navigateTo("home-page");
        document.querySelectorAll(".nav-item").forEach((item) =>
          item.addEventListener("click", (e) => {
            e.preventDefault();
            navigateTo(item.dataset.page);
          })
        );
      }

      // --- NAVIGATION ROUTER ---
      function navigateTo(pageId) {
        const mainContent = document.getElementById("main-content");
        mainContent.innerHTML = getPageContent(pageId);

        switch (pageId) {
          case "home-page":
            setupHomePageListeners();
            break;
          case "resume-page":
            setupResumePageListeners();
            break;
          case "my-jobs-page":
            renderMyJobsContent();
            break;
          case "messages-page":
            renderMessagesContent();
            break;
          case "profile-page":
            renderProfileContent();
            break;
          case "premium-page":
            setupPremiumPageListeners();
            break;
          case "payment-page":
            // This is handled by navigateToPayment
            break;
          // AI flow pages are handled by the functions that call them
          case "suggestions-page":
            break;
          case "resume-jobs-page":
            break;
        }

        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.toggle("active", item.dataset.page === pageId);
          item.classList.toggle("text-gray-500", item.dataset.page !== pageId);
        });
      }

      function getPageContent(pageId) {
        const padding = (pageId === "chat-view-container" || pageId === "premium-page") ? "" : "p-4";
        return `<div id="${pageId}-content" class="${padding}">${getPageHTML(
          pageId
        )}</div>`;
      }

      function getPageHTML(pageId) {
        switch (pageId) {
          case "home-page":
            return `<header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b"><div class="flex justify-between items-center"> <h1 class="text-2xl font-bold text-primary">berozgaars...</h1> <i class="fas fa-bell text-gray-500 text-xl"></i> </div></header><div class="p-4"><div class="relative mb-4"> <input type="text" id="job-search-input" placeholder="Job title, skills, or company" class="w-full p-3 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"> <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i> </div> <div class="relative mb-4"> <input type="text" list="indian-cities" id="city-search-input" placeholder="Enter city or locality" class="w-full p-3 pl-10 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"> <i class="fas fa-map-marker-alt absolute left-3 top-3.5 text-gray-400"></i> <datalist id="indian-cities"></datalist> </div> <button id="show-resume-upload" class="w-full bg-primary text-primary font-bold py-3 px-4 rounded-lg mb-6 flex items-center justify-center hover:bg-green-200 transition-colors"> <i class="fas fa-rocket mr-2"></i> Boost Your Profile with AI </button> <div id="passion-selection-section" class="mb-6 p-3 bg-teal-50 rounded-lg"> <h3 class="text-base font-semibold text-gray-800 mb-2">What are you passionate about?</h3> <p class="text-xs text-gray-600 mb-3">Select a few fields to get better recommendations.</p> <div id="passion-buttons" class="flex flex-wrap gap-2"></div> </div> <div id="recommendations-section" class="mb-8"> <h2 class="text-xl font-semibold text-gray-800 mb-3">Recommended for You</h2> <div id="job-listings-recommended" class="space-y-4"></div> </div> <div> <h2 class="text-xl font-semibold text-gray-800 mb-3">All Jobs</h2> <div id="job-listings-all" class="space-y-4"></div></div></div>`;
          case "resume-page":
            return `<header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b"><h1 class="text-2xl font-bold text-primary">AI Resume Analyzer</h1></header><div class="p-4"><p class="text-gray-600 mb-6">Upload your resume and LinkedIn profile. Our Gemini-powered AI will provide suggestions to supercharge your job hunt.</p><div class="mb-6"><label class="block text-lg font-medium text-gray-700 mb-2">Upload Resume</label><div id="resume-drop-zone" class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-secondary transition-colors"><label for="resume-file" class="w-full h-full flex flex-col items-center justify-center cursor-pointer"><div class="space-y-1 text-center"><i class="fas fa-cloud-upload-alt mx-auto h-12 w-12 text-gray-400"></i><div class="flex text-sm text-gray-600"><span class="font-medium text-secondary">Click to upload</span><p class="pl-1">or drag and drop</p></div><p class="text-xs text-gray-500">PDF, DOC, DOCX up to 10MB</p><p id="file-name" class="text-sm text-green-600 font-semibold"></p></div><input id="resume-file" name="resume-file" type="file" class="sr-only"></label></div></div><div class="mb-6"><label class="block text-lg font-medium text-gray-700 mb-2">LinkedIn Profile URL</label><input type="url" id="linkedin-url" placeholder="https://linkedin.com/in/your-profile" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary"></div><button id="get-suggestions-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg flex items-center justify-center"><i class="fas fa-lightbulb mr-2"></i> Get AI Suggestions</button></div>`;
          case "suggestions-page":
            return `<header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b"><h1 class="text-2xl font-bold text-primary">AI Suggestions</h1></header><div class="pt-4"><div id="suggestions-loader" class="flex justify-center items-center h-40"><div class="loader"></div></div><div id="suggestions-content" class="hidden"><p class="text-gray-600 mb-6">Here are some suggestions to improve your resume and LinkedIn profile:</p><div id="suggestions-list" class="space-y-4 mb-6"></div><button id="find-jobs-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg">Find Jobs for My Profile</button></div></div>`;
          case "resume-jobs-page":
            return `<header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b"><h1 class="text-2xl font-bold text-primary">Jobs For You</h1></header><div class="pt-4"><p class="text-gray-600 mb-6">Based on our AI analysis, these entry-level jobs seem like a great fit for you.</p><div id="resume-jobs-loader" class="flex justify-center items-center h-40"><div class="loader"></div></div><div id="job-listings-resume" class="space-y-4"></div></div>`;
          case "my-jobs-page":
            return `<div id="my-jobs-content-wrapper"></div>`;
          case "messages-page":
            return `<div id="messages-content-wrapper"></div>`;
          case "profile-page":
            return `<div id="profile-content-wrapper"></div>`;
          case "premium-page":
            return getPremiumPageHTML();
          case "payment-page":
            return `<div id="payment-gateway-wrapper"></div>`;
          default:
            return "";
        }
      }

      // --- PAGE-SPECIFIC SETUP FUNCTIONS ---
      function setupHomePageListeners() {
          populateCities();
          renderPassionSelector();
          // Immediately render jobs from the local array
          renderJobs(allJobs, "job-listings-all"); 
          renderRecommendedJobs();

          document.getElementById("job-search-input").addEventListener("input", handleSearch);
          document.getElementById("city-search-input").addEventListener("input", handleSearch);
          document.getElementById("show-resume-upload").addEventListener("click", () => navigateTo("resume-page"));

          // Fetch AI jobs in the background and append them
          fetchAIJobs().then(aiJobs => {
              if (aiJobs.length > 0) {
                  allJobs.push(...aiJobs);
                  appendAIJobs(aiJobs);
              }
          });
      }


      function setupResumePageListeners() {
        const dropZone = document.getElementById("resume-drop-zone");
        const fileInput = document.getElementById("resume-file");

        fileInput.addEventListener("change", (e) =>
          handleFileSelect(e.target.files)
        );

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.add("border-secondary", "bg-teal-50");
        });

        dropZone.addEventListener("dragleave", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("border-secondary", "bg-teal-50");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropZone.classList.remove("border-secondary", "bg-teal-50");
          handleFileSelect(e.dataTransfer.files);
        });

        document
          .getElementById("get-suggestions-btn")
          .addEventListener("click", getResumeSuggestions);
      }

      function setupSuggestionsPageListeners(suggestions) {
        const loader = document.getElementById("suggestions-loader");
        const content = document.getElementById("suggestions-content");
        const list = document.getElementById("suggestions-list");
        list.innerHTML = "";
        suggestions.forEach((s) => {
          list.innerHTML += `<div class="flex items-start p-3 bg-gray-100 rounded-lg"><i class="${s.icon} text-secondary text-xl w-8 text-center mt-1"></i><p class="ml-3 text-gray-700">${s.text}</p></div>`;
        });
        loader.style.display = "none";
        content.classList.remove("hidden");
        document
          .getElementById("find-jobs-btn")
          .addEventListener("click", findJobsForResume);
      }

      function setupResumeJobsPageListeners(matchedJobs) {
        const loader = document.getElementById("resume-jobs-loader");
        loader.style.display = "none";
        renderJobs(matchedJobs, "job-listings-resume");
      }

      // --- CORE LOGIC ---
      function handleSearch() {
        const query = document
          .getElementById("job-search-input")
          .value.toLowerCase();
        const city = document
          .getElementById("city-search-input")
          .value.toLowerCase();
        if (query.length > 2 && !userSearchHistory.includes(query)) {
          userSearchHistory.push(query);
        }
        const filteredJobs = allJobs.filter((job) => {
          const searchCorpus = `${job.title} ${
            job.company
          } ${job.details.skills.join(" ")}`.toLowerCase();
          return (
            searchCorpus.includes(query) &&
            job.location.toLowerCase().includes(city)
          );
        });
        renderJobs(filteredJobs, "job-listings-all");
        renderRecommendedJobs();
      }

      function renderJobs(jobs, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = jobs.length
          ? ""
          : '<p class="text-gray-500 text-center p-4">No jobs found.</p>';
        jobs.forEach((job) => {
          const jobCard = document.createElement("div");
          jobCard.className =
            "p-4 border rounded-lg bg-white shadow-sm cursor-pointer hover:shadow-md transition-all duration-300";
          
          jobCard.innerHTML = `
              <div class="flex justify-between items-start">
                  <h3 class="text-lg font-bold text-secondary">${job.title}</h3>
                  <span class="text-xs font-semibold ${
                    job.source === "Berozgaars"
                      ? "bg-green-100 text-green-800"
                      : "bg-gray-200 text-gray-600"
                  } px-2 py-1 rounded-full">${job.source}</span>
              </div>
              <p class="font-semibold text-gray-700">${job.company}</p>
              <p class="text-sm text-gray-500 mb-2">${job.location}</p>
              <p class="text-base font-semibold text-green-600">${job.salary}</p>
          `;
          jobCard.addEventListener("click", () => openJobDetailsModal(job.id));
          container.appendChild(jobCard);
        });
      }
      
      function appendAIJobs(jobs) {
          const container = document.getElementById('job-listings-all');
          if (!container) return;
          jobs.forEach((job) => {
              const jobCard = document.createElement("div");
              jobCard.className = "p-4 border rounded-lg bg-white shadow-sm cursor-pointer hover:shadow-md transition-all duration-300";
              
              jobCard.innerHTML = `
                  <div class="flex justify-between items-start">
                      <h3 class="text-lg font-bold text-secondary">${job.title}</h3>
                      <span class="text-xs font-semibold ${
                        job.source === "Berozgaars"
                          ? "bg-green-100 text-green-800"
                          : "bg-gray-200 text-gray-600"
                      } px-2 py-1 rounded-full">${job.source}</span>
                  </div>
                  <p class="font-semibold text-gray-700">${job.company}</p>
                  <p class="text-sm text-gray-500 mb-2">${job.location}</p>
                  <p class="text-base font-semibold text-green-600">${job.salary}</p>
              `;
              jobCard.addEventListener("click", () => openJobDetailsModal(job.id));
              container.appendChild(jobCard);
          });
      }


      function renderRecommendedJobs() {
        const container = document.getElementById("job-listings-recommended");
        if (!container) return;
        let recommendations = [];
        const recommendedSet = new Set();
        const preferenceKeywords = {
          Tech: ["software", "engineer", "developer", "python", "java", "react", "data"],
          Marketing: ["marketing", "seo", "sem", "content", "social media"],
          Design: ["design", "illustrator", "figma", "photoshop", "ui/ux"],
          Finance: ["analyst", "finance", "accounting", "audit"],
          Engineering: ["civil", "mechanical", "electrical", "trainee", "autocad"],
          Sales: ["sales", "bde", "business development", "client"],
          HR: ["hr", "human resources", "recruitment"],
        };

        if (userJobPreferences.length > 0) {
          userJobPreferences.forEach((pref) => {
            const keywords = preferenceKeywords[pref] || [pref.toLowerCase()];
            allJobs.forEach((job) => {
              const searchCorpus = `${job.title} ${job.details.description} ${job.details.skills.join(" ")}`.toLowerCase();
              if (keywords.some((kw) => searchCorpus.includes(kw))) {
                recommendedSet.add(job);
              }
            });
          });
        }

        if (userSearchHistory.length > 0) {
          userSearchHistory.forEach((term) => {
            allJobs.forEach((job) => {
              const searchCorpus = `${job.title} ${job.details.skills.join(" ")}`.toLowerCase();
              if (searchCorpus.includes(term)) recommendedSet.add(job);
            });
          });
        }
        
        recommendations = Array.from(recommendedSet);

        const hasCareersJob = recommendations.some(job => job.source === "Careers");

        if (!hasCareersJob) {
            const careersJob = allJobs.find(job => job.source === "Careers" && !recommendedSet.has(job));
            if (careersJob) {
                if (recommendations.length < 4) {
                    recommendations.push(careersJob);
                } else {
                    recommendations.pop(); 
                    recommendations.push(careersJob);
                }
            }
        }
        
        const hasBerozgaarsJob = recommendations.some(job => job.source === "Berozgaars");
        if(!hasBerozgaarsJob) {
            const berozgaarsJob = allJobs.find(job => job.source === "Berozgaars" && !recommendedSet.has(job));
            if(berozgaarsJob) {
                 if (recommendations.length < 4) {
                    recommendations.push(berozgaarsJob);
                } else {
                    recommendations.pop(); 
                    recommendations.push(berozgaarsJob);
                }
            }
        }

        if (recommendations.length === 0) {
          allJobs
            .filter((job) => job.title.toLowerCase().includes("software"))
            .slice(0, 2)
            .forEach((job) => recommendations.push(job));
        }

        recommendations = recommendations.slice(0, 4);

        if (recommendations.length > 0)
          renderJobs(recommendations, "job-listings-recommended");
        else
          container.innerHTML =
            '<p class="text-gray-500 text-center p-4">Select your passions to get personalized recommendations.</p>';
      }

      function renderPassionSelector() {
        const container = document.getElementById("passion-buttons");
        if (!container) return;
        container.innerHTML = "";
        jobCategories.forEach((cat) => {
          const isSelected = userJobPreferences.includes(cat);
          const button = document.createElement("button");
          button.className = `passion-btn font-semibold py-1 px-3 text-sm rounded-full transition-colors ${
            isSelected ? "selected" : ""
          }`;
          button.textContent = cat;
          button.dataset.passion = cat;
          button.addEventListener("click", () => handlePassionSelect(cat));
          container.appendChild(button);
        });
      }

      function handlePassionSelect(passion) {
        const index = userJobPreferences.indexOf(passion);
        if (index > -1) {
          userJobPreferences.splice(index, 1);
        } else {
          userJobPreferences.push(passion);
        }
        localStorage.setItem(
          "userJobPreferences",
          JSON.stringify(userJobPreferences)
        );
        renderPassionSelector();
        renderRecommendedJobs();
      }

      function handleFileSelect(files, fromModal = false, jobId = null) {
          if (files && files.length > 0) {
              const file = files[0];
              if (fromModal) {
                  const fileNameEl = document.getElementById('easy-apply-file-name');
                  if (fileNameEl) {
                      fileNameEl.textContent = file.name;
                      fileNameEl.classList.remove('hidden');
                  }
                  const fileInfoEl = document.getElementById('easy-apply-file-info');
                  if (fileInfoEl) {
                      fileInfoEl.classList.add('hidden');
                  }
              } else {
                  userResume.file = file;
                  userResume.fileName = file.name;
                  document.getElementById("file-name").textContent = userResume.fileName;
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      userResume.text = event.target.result;
                  };
                  reader.readAsText(userResume.file);
              }
          }
      }


      // --- GEMINI API INTEGRATION ---
      async function fetchAIJobs() {
          const prompt = `Generate a JSON array of 4 realistic, entry-level job postings suitable for the Indian job market. Ensure a mix of "native" and "external" apply types. Each object in the array must have the following keys: "id" (a unique integer starting from 100), "title", "company", "location" (an Indian city), "salary", "type" (e.g., "Full-time", "Internship"), "source" (use "Berozgaars" for native, or realistic sources like "LinkedIn", "Naukri" for external), "applyType" ("native" or "external"), "applyLink" ("#" for native, a placeholder URL for external), and a "details" object containing "description", an array of "responsibilities", and an array of "skills".`;
          try {
              const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
              const payload = {
                  contents: [{ role: "user", parts: [{ text: prompt }] }],
                  generationConfig: { 
                      responseMimeType: "application/json",
                      responseSchema: {
                          type: "ARRAY",
                          items: {
                              type: "OBJECT",
                              properties: {
                                  id: { type: "INTEGER" },
                                  title: { type: "STRING" },
                                  company: { type: "STRING" },
                                  location: { type: "STRING" },
                                  salary: { type: "STRING" },
                                  type: { type: "STRING" },
                                  source: { type: "STRING" },
                                  applyType: { type: "STRING" },
                                  applyLink: { type: "STRING" },
                                  details: {
                                      type: "OBJECT",
                                      properties: {
                                          description: { type: "STRING" },
                                          responsibilities: { type: "ARRAY", items: { type: "STRING" } },
                                          skills: { type: "ARRAY", items: { type: "STRING" } }
                                      },
                                      required: ["description", "responsibilities", "skills"]
                                  }
                              },
                              required: ["id", "title", "company", "location", "salary", "type", "source", "applyType", "applyLink", "details"]
                          }
                      }
                  }
              };
              const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });
              if (!response.ok) throw new Error(`API Error: ${response.status}`);
              const result = await response.json();
              if (result.candidates && result.candidates[0].content.parts.length > 0) {
                  const aiJobs = JSON.parse(result.candidates[0].content.parts[0].text);
                  const existingIds = new Set(allJobs.map(j => j.id));
                  return aiJobs.filter(job => !existingIds.has(job.id));
              }
              return [];
          } catch (error) {
              console.error("AI Jobs Fetch Error:", error);
              return []; // Return empty array on error
          }
      }

      async function getResumeSuggestions() {
        const getSuggestionsBtn = document.getElementById(
          "get-suggestions-btn"
        );
        userResume.linkedin = document.getElementById("linkedin-url").value;
        if (!userResume.text) {
          openModal("Error", "<p>Please upload your resume first.</p>");
          return;
        }

        getSuggestionsBtn.disabled = true;
        getSuggestionsBtn.innerHTML = `<div class="loader !w-6 !h-6 !border-2"></div>`;

        navigateTo("suggestions-page");

        const prompt = `Analyze the following resume and LinkedIn profile for an entry-level job seeker in India. Provide 4 actionable suggestions for improvement and a list of up to 5 key skills extracted from the resume. Return a single JSON object with two keys: "suggestions" and "skills". The "suggestions" key should have an array of objects, where each object has an "icon" and a "text" field. For the 'icon' field, choose one of these Font Awesome classes: 'fas fa-bullseye', 'fas fa-star', 'fas fa-keyboard', 'fab fa-linkedin'. The "skills" key should have an array of strings. Resume: "${userResume.text}". LinkedIn: "${userResume.linkedin}".`;

        try {
          const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  suggestions: {
                    type: "ARRAY",
                    items: {
                      type: "OBJECT",
                      properties: {
                        icon: { type: "STRING" },
                        text: { type: "STRING" },
                      },
                      required: ["icon", "text"],
                    },
                  },
                  skills: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                  },
                },
                required: ["suggestions", "skills"],
              },
            },
          };
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();

          if (
            result.candidates &&
            result.candidates[0].content &&
            result.candidates[0].content.parts.length > 0
          ) {
            const aiResponse = JSON.parse(
              result.candidates[0].content.parts[0].text
            );
            userResume.skills = aiResponse.skills || []; // Store extracted skills
            setupSuggestionsPageListeners(aiResponse.suggestions);
          } else {
            throw new Error("Invalid response structure from AI.");
          }
        } catch (error) {
          console.error("AI Suggestions Error:", error);
          const fallbackSuggestions = [
            {
              icon: "fas fa-exclamation-triangle",
              text: "Could not get AI suggestions. Please check the API key or try again later.",
            },
          ];
          setupSuggestionsPageListeners(fallbackSuggestions);
        } finally {
          const btn = document.getElementById("get-suggestions-btn");
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-lightbulb mr-2"></i> Get AI Suggestions`;
          }
        }
      }

      function findJobsForResume() {
        navigateTo("resume-jobs-page");
        const resumeKeywords = userResume.skills;
        let matchedJobs = [];

        if (resumeKeywords && resumeKeywords.length > 0) {
          matchedJobs = allJobs.filter((job) => {
            const searchCorpus = `${job.title} ${
              job.details.description
            } ${job.details.skills.join(" ")}`.toLowerCase();
            return resumeKeywords.some((kw) =>
              searchCorpus.includes(kw.toLowerCase())
            );
          });
        }

        if (matchedJobs.length === 0) {
          matchedJobs = allJobs.slice(0, 5);
        }

        setupResumeJobsPageListeners(matchedJobs);
      }

      function requestLocationPermission() {
        console.log("Requesting user location permission...");
      }

      function openJobDetailsModal(jobId) {
        const job = allJobs.find((j) => j.id === jobId);
        if (!job) return;

        let applyButtonHTML = '';
        if (job.applyType === 'native') {
            applyButtonHTML = `<button onclick="openEasyApplyModal(${job.id})" class="w-full btn-secondary font-bold py-3 rounded-lg mt-3">Easy Apply on Berozgaars</button>`;
        } else {
            applyButtonHTML = `<button onclick="handleApplyNow(${job.id})" class="w-full btn-primary font-bold py-3 rounded-lg mt-3">Apply Now on ${job.source} <i class="fas fa-external-link-alt ml-2"></i></button>`;
        }

        const content = `
                <div class="pb-4">
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="text-2xl font-bold text-secondary">${
                          job.title
                        }</h2>
                        <span class="text-sm font-semibold ${
                          job.source === "Berozgaars"
                            ? "bg-green-100 text-green-800"
                            : "bg-gray-200 text-gray-600"
                        } px-2 py-1 rounded-full">${job.source}</span>
                    </div>
                    <p class="text-lg font-semibold text-gray-800">${
                      job.company
                    }</p>
                    <p class="text-gray-600 mb-2">${job.location}</p>
                    <p class="text-lg font-bold text-green-700 mb-4">${
                      job.salary
                    }</p>
                    
                    <h3 class="font-bold text-gray-800 mt-4 mb-2">Job Description</h3>
                    <p class="text-gray-600">${job.details.description}</p>
                    
                    <h3 class="font-bold text-gray-800 mt-4 mb-2">Responsibilities</h3>
                    <ul class="list-disc list-inside text-gray-600 space-y-1">${job.details.responsibilities
                      .map((r) => `<li>${r}</li>`)
                      .join("")}</ul>
                    
                    <h3 class="font-bold text-gray-800 mt-4 mb-2">Required Skills</h3>
                    <div class="flex flex-wrap gap-2">${job.details.skills
                      .map(
                        (s) =>
                          `<span class="bg-primary text-primary text-sm font-medium px-3 py-1 rounded-full">${s}</span>`
                      )
                      .join("")}</div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
                        <button onclick="prepareForInterview(${
                          job.id
                        })" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg flex items-center justify-center">✨ Prepare for Interview</button>
                        <button onclick="draftCoverLetter(${
                          job.id
                        })" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg flex items-center justify-center">✨ Draft Cover Letter</button>
                    </div>
                    ${applyButtonHTML}
                </div>`;
        openModal("Job Details", content);
      }

      function handleApplyNow(jobId) {
        const job = allJobs.find((j) => j.id === jobId);
        if (!job) return;

        const preference = localStorage.getItem("linkPreference");
        if (preference === "external") {
          window.open(job.applyLink, "_blank");
        } else if (preference === "in-app") {
          openInAppBrowser(job.applyLink, job.company);
        } else {
          promptLinkPreference(jobId);
        }
      }

      function promptLinkPreference(jobId) {
        const job = allJobs.find((j) => j.id === jobId);
        if (!job) return;

        const modalContent = `
                <p class="text-center text-gray-700 mb-4">How would you like to open the application link?</p>
                <div class="space-y-3">
                    <button id="open-in-browser" class="w-full px-4 py-3 bg-gray-200 rounded-lg font-semibold">Open in System Browser</button>
                    <button id="open-in-app" class="w-full px-4 py-3 btn-primary rounded-lg font-semibold">Open in App</button>
                </div>
                <div class="mt-4 flex items-center">
                    <input type="checkbox" id="remember-choice" class="h-4 w-4 rounded border-gray-300 text-secondary focus:ring-secondary">
                    <label for="remember-choice" class="ml-2 block text-sm text-gray-900">Remember my choice</label>
                </div>
            `;
        openModal("Leaving berozgaars...", modalContent);

        document.getElementById("open-in-browser").onclick = () => {
          if (document.getElementById("remember-choice").checked) {
            localStorage.setItem("linkPreference", "external");
          }
          window.open(job.applyLink, "_blank");
          closeModal();
        };
        document.getElementById("open-in-app").onclick = () => {
          if (document.getElementById("remember-choice").checked) {
            localStorage.setItem("linkPreference", "in-app");
          }
          closeModal();
          openInAppBrowser(job.applyLink, job.company);
        };
      }

      function openInAppBrowser(url, title) {
        const browserHTML = `
                <div id="in-app-browser" class="in-app-browser-overlay">
                    <div class="in-app-browser-header bg-white">
                        <button id="close-in-app-browser" class="p-2 mr-2"><i class="fas fa-times text-xl text-gray-600"></i></button>
                        <div>
                            <p class="font-bold text-gray-800">${title}</p>
                            <p class="text-sm text-gray-500 truncate">${url}</p>
                        </div>
                    </div>
                    <iframe src="${url}" class="in-app-browser-iframe"></iframe>
                </div>
            `;
        document.body.insertAdjacentHTML("beforeend", browserHTML);
        setTimeout(() => {
          document.getElementById("in-app-browser").classList.add("open");
        }, 10);
        document
          .getElementById("close-in-app-browser")
          .addEventListener("click", closeInAppBrowser);
      }

      function closeInAppBrowser() {
        const browser = document.getElementById("in-app-browser");
        if (browser) {
          browser.classList.remove("open");
          setTimeout(() => {
            browser.remove();
          }, 300);
        }
      }

      async function prepareForInterview(jobId) {
        const job = allJobs.find((j) => j.id === jobId);
        const modalContent = `<div id="interview-prep-loader" class="flex justify-center items-center h-40"><div class="loader"></div></div><div id="interview-prep-content"></div>`;
        openModal(`Interview Prep: ${job.title}`, modalContent);

        const prompt = `I am a student in India preparing for an entry-level job interview for the position of "${
          job.title
        }" at "${job.company}". The job description is: "${
          job.details.description
        }". The required skills are: "${job.details.skills.join(
          ", "
        )}". Please generate a list of likely interview questions and tips for me. Structure the response as a JSON object with three keys: "behavioral_questions", "technical_questions", and "questions_to_ask". Each key should contain an array of 3-4 relevant questions as strings.`;

        try {
          const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  behavioral_questions: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                  },
                  technical_questions: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                  },
                  questions_to_ask: {
                    type: "ARRAY",
                    items: { type: "STRING" },
                  },
                },
                required: [
                  "behavioral_questions",
                  "technical_questions",
                  "questions_to_ask",
                ],
              },
            },
          };
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          const result = await response.json();
          const data = JSON.parse(result.candidates[0].content.parts[0].text);

          const prepContent = document.getElementById("interview-prep-content");
          prepContent.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-bold text-lg text-secondary mb-2">💡 Behavioral Questions</h4>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">${data.behavioral_questions
                              .map((q) => `<li>${q}</li>`)
                              .join("")}</ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-secondary mb-2">💻 Technical Questions</h4>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">${data.technical_questions
                              .map((q) => `<li>${q}</li>`)
                              .join("")}</ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-secondary mb-2">🤔 Questions You Can Ask</h4>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">${data.questions_to_ask
                              .map((q) => `<li>${q}</li>`)
                              .join("")}</ul>
                        </div>
                    </div>
                `;
          document.getElementById("interview-prep-loader").style.display =
            "none";
        } catch (error) {
          console.error("Interview Prep Error:", error);
          document.getElementById(
            "interview-prep-content"
          ).innerHTML = `<p class="text-red-500">Could not generate interview prep. Please try again later.</p>`;
          document.getElementById("interview-prep-loader").style.display =
            "none";
        }
      }

      async function draftCoverLetter(jobId) {
        const job = allJobs.find((j) => j.id === jobId);
        const modalContent = `<div id="cover-letter-loader" class="flex justify-center items-center h-40"><div class="loader"></div></div><div id="cover-letter-content" class="hidden"><textarea id="cover-letter-text" class="w-full h-64 p-2 border rounded-md"></textarea><button id="copy-cover-letter" class="btn-primary w-full mt-2 py-2 rounded-lg">Copy Text</button></div>`;
        openModal(`Cover Letter Draft: ${job.title}`, modalContent);

        const prompt = `I am a student in India named "${currentUser.name}" applying for the position of "${job.title}" at "${job.company}". My resume summary is: "${userResume.text}". Please write a professional and concise cover letter for me. The letter should be enthusiastic and tailored to the job description: "${job.details.description}".`;

        try {
          const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
          const payload = {
            contents: [{ role: "user", parts: [{ text: prompt }] }],
          };
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) throw new Error(`API Error: ${response.status}`);
          const result = await response.json();
          const coverLetterText = result.candidates[0].content.parts[0].text;

          document.getElementById("cover-letter-loader").style.display = "none";
          const contentDiv = document.getElementById("cover-letter-content");
          contentDiv.classList.remove("hidden");
          document.getElementById("cover-letter-text").value = coverLetterText;
          document
            .getElementById("copy-cover-letter")
            .addEventListener("click", () => {
              const textArea = document.getElementById("cover-letter-text");
              textArea.select();
              document.execCommand("copy");
              // Use a custom modal/toast instead of alert
              const copyButton = document.getElementById("copy-cover-letter");
              copyButton.textContent = "Copied!";
              setTimeout(() => {
                copyButton.textContent = "Copy Text";
              }, 2000);
            });
        } catch (error) {
          console.error("Cover Letter Error:", error);
          document.getElementById(
            "cover-letter-content"
          ).innerHTML = `<p class="text-red-500">Could not generate cover letter. Please try again later.</p>`;
          document.getElementById("cover-letter-loader").style.display = "none";
          document
            .getElementById("cover-letter-content")
            .classList.remove("hidden");
        }
      }

      function openModal(title, content) {
        const modalsContainer = document.getElementById("modals-container");
        modalsContainer.innerHTML = `<div class="modal-overlay" id="modal-overlay"><div class="modal-content"><div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-xl font-bold text-primary">${title}</h2><button id="close-modal-btn" class="text-gray-500 text-2xl hover:text-gray-800">&times;</button></div><div id="modal-body">${content}</div></div></div>`;
        document
          .getElementById("close-modal-btn")
          .addEventListener("click", closeModal);
        document
          .getElementById("modal-overlay")
          .addEventListener("click", (e) => {
            if (e.target.id === "modal-overlay") closeModal();
          });
      }
      function closeModal() {
        document.getElementById("modals-container").innerHTML = "";
      }
      function populateCities() {
        const datalist = document.getElementById("indian-cities");
        if (!datalist) return;
        datalist.innerHTML = "";
        indianCities.forEach((city) => {
          const option = document.createElement("option");
          option.value = city;
          datalist.appendChild(option);
        });
      }

      function renderProfileContent() {
        const wrapper = document.getElementById("profile-content-wrapper");
        if (!wrapper) return;

        const upgradeButtonHTML = currentUser.isPremium ? 
            `<span class="text-sm font-semibold py-1 px-3 rounded-full flex items-center text-yellow-500 bg-yellow-100 border border-yellow-300"><i class="fas fa-star text-xs mr-2"></i> Premium</span>` :
            `<button onclick="navigateTo('premium-page')" class="premium-btn text-sm font-bold py-1 px-3 rounded-full flex items-center">
                <i class="fas fa-star text-xs mr-2"></i> Upgrade
            </button>`;

        wrapper.innerHTML = `
                <header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-primary">Profile</h1>
                    ${upgradeButtonHTML}
                </header>
                <div class="p-4">
                    <div class="flex items-center mb-6"> <div class="w-20 h-20 rounded-full bg-secondary flex items-center justify-center text-white text-3xl font-bold mr-4">${currentUser.name.charAt(
                      0
                    )}</div> <div> <h2 class="text-2xl font-bold text-gray-800">${
          currentUser.name
        }</h2> <p class="text-gray-500">Kolkata, West Bengal, India</p> <p class="text-sm text-secondary">Aspiring Software Developer</p> </div> </div> <div class="mb-8"> <div class="flex justify-between items-center mb-3"> <h3 class="text-xl font-semibold text-gray-800">Portfolios & Projects</h3> <button id="add-portfolio-btn" class="text-secondary hover:text-primary"><i class="fas fa-plus-circle text-2xl"></i></button> </div> <div id="portfolio-list" class="space-y-3"></div> </div> <div> <h3 class="text-xl font-semibold text-gray-800 mb-3">Recommendations</h3> <div class="flex mb-4 border-b"> <button class="tab-item active flex-1 p-3 font-semibold" data-tab="received">Received</button> <button class="tab-item flex-1 p-3 font-semibold text-gray-500" data-tab="given">Given</button> </div> <div id="received-tab" class="tab-content active"> <button id="request-rec-btn" class="w-full border-2 border-dashed border-gray-300 text-gray-500 rounded-lg py-3 mb-4 hover:bg-gray-50">Request a recommendation</button> <div id="recommendations-received-list" class="space-y-4"></div> </div> <div id="given-tab" class="tab-content"> <div id="recommendations-given-list" class="space-y-4"></div> </div> </div>
                    <div class="mt-8 border-t pt-4">
                        <button onclick="handleLogout()" class="w-full text-left text-red-600 font-semibold p-3 hover:bg-red-50 rounded-lg"><i class="fas fa-sign-out-alt w-6 mr-2"></i>Logout</button>
                    </div>
                </div>
            `;

        document
          .getElementById("add-portfolio-btn")
          .addEventListener("click", openPortfolioModal);
        document
          .getElementById("request-rec-btn")
          .addEventListener("click", openRequestRecModal);
        document.querySelectorAll(".tab-item").forEach((item) =>
          item.addEventListener("click", (e) => {
            const tabId = e.target.dataset.tab;
            document.querySelectorAll(".tab-item").forEach((t) => {
              t.classList.remove("active");
              t.classList.add("text-gray-500");
            });
            e.target.classList.add("active");
            e.target.classList.remove("text-gray-500");
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.remove("active"));
            document.getElementById(`${tabId}-tab`).classList.add("active");
          })
        );

        renderPortfolios();
        renderRecommendations();
      }

      function renderPortfolios() {
        const list = document.getElementById("portfolio-list");
        if (!list) return;
        list.innerHTML = "";
        userPortfolios.forEach((p, index) => {
          const item = document.createElement("div");
          item.className =
            "bg-gray-50 p-3 rounded-lg flex items-center justify-between";
          item.innerHTML = `<div class="flex items-center"><div class="w-10 h-10 bg-secondary text-white flex items-center justify-center rounded-md mr-4"><i class="fas fa-link"></i></div><div><p class="font-semibold text-gray-800">${p.title}</p><a href="${p.url}" target="_blank" class="text-sm text-blue-600 hover:underline">${p.url}</a></div></div><button class="text-gray-400 hover:text-red-500" onclick="deletePortfolio(${index})"><i class="fas fa-trash"></i></button>`;
          list.appendChild(item);
        });
      }

      function deletePortfolio(index) {
        userPortfolios.splice(index, 1);
        renderPortfolios();
      }

      function renderRecommendations() {
        const receivedList = document.getElementById(
          "recommendations-received-list"
        );
        const givenList = document.getElementById("recommendations-given-list");
        if (!receivedList || !givenList) return;

        receivedList.innerHTML = "";
        userRecommendations.received.forEach((rec) => {
          if (rec.status !== "approved") return;
          const item = document.createElement("div");
          item.className = "p-4 border rounded-lg";
          item.innerHTML = `<div class="flex items-start"><div class="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-xl font-bold text-white mr-4">${rec.from.charAt(
            0
          )}</div><div><p class="font-bold text-gray-800">${
            rec.from
          }</p><p class="text-sm text-gray-500">${
            rec.relationship
          }</p></div></div><p class="mt-3 text-gray-600">"${rec.text}"</p>`;
          receivedList.appendChild(item);
        });
        if (receivedList.innerHTML === "")
          receivedList.innerHTML = `<p class="text-center text-gray-500 py-4">No recommendations to show.</p>`;

        givenList.innerHTML = "";
        userRecommendations.given.forEach((rec) => {
          const item = document.createElement("div");
          item.className = "p-4 border rounded-lg";
          item.innerHTML = `<div class="flex items-start"><div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-xl font-bold text-gray-600 mr-4">${rec.to.charAt(
            0
          )}</div><div><p class="font-bold text-gray-800">${
            rec.to
          }</p><p class="text-sm text-gray-500">${
            rec.relationship
          }</p></div></div><p class="mt-3 text-gray-600">"${rec.text}"</p>`;
          givenList.appendChild(item);
        });
        if (givenList.innerHTML === "")
          givenList.innerHTML = `<p class="text-center text-gray-500 py-4">You haven't given any recommendations yet.</p>`;
      }

      function openPortfolioModal() {
        const content = `<form id="portfolio-form"><div class="mb-4"><label for="portfolio-title" class="block text-sm font-medium text-gray-700">Title</label><input type="text" id="portfolio-title" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., My Design Work" required></div><div class="mb-4"><label for="portfolio-url" class="block text-sm font-medium text-gray-700">URL</label><input type="url" id="portfolio-url" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="https://..." required></div><button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-lg">Add Portfolio</button></form>`;
        openModal("Add Portfolio/Project Link", content);
        document
          .getElementById("portfolio-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            addPortfolio();
          });
      }

      function addPortfolio() {
        const title = document.getElementById("portfolio-title").value;
        const url = document.getElementById("portfolio-url").value;
        userPortfolios.push({ title, url });
        renderPortfolios();
        closeModal();
      }

      function openRequestRecModal() {
        const content = `<form id="request-rec-form"><div class="mb-4"><label for="rec-from" class="block text-sm font-medium text-gray-700">Who do you want to ask?</label><input type="text" id="rec-from" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., Priya Patel" required></div><div class="mb-4"><label for="rec-message" class="block text-sm font-medium text-gray-700">Include a personal message</label><textarea id="rec-message" rows="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Hi Priya, would you be able to write me a brief recommendation about our time working together at...?"></textarea></div><button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-lg">Send Request</button></form>`;
        openModal("Request a Recommendation", content);
        document
          .getElementById("request-rec-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            openModal("Success", "<p>Recommendation request sent! (Simulation)</p>");
          });
      }

      function renderMyJobsContent() {
        const wrapper = document.getElementById("my-jobs-content-wrapper");
        if (!wrapper) return;
        
        const savedJobs = allJobs.filter(job => userSavedJobs.includes(job.id));
        const appliedJobs = allJobs.filter(job => userAppliedJobs.includes(job.id));
        const interviews = allJobs.filter(job => userInterviewJobs.includes(job.id));

        wrapper.innerHTML = `
                <header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b"><h1 class="text-2xl font-bold text-primary">My Jobs</h1></header>
                <div class="p-4">
                    <div class="flex border-b mb-4">
                        <button class="my-jobs-tab-item active flex-1 p-3 text-sm font-semibold" data-tab="saved">Saved (${savedJobs.length})</button>
                        <button class="my-jobs-tab-item flex-1 p-3 text-sm font-semibold text-gray-500" data-tab="applied">Applied (${appliedJobs.length})</button>
                        <button class="my-jobs-tab-item flex-1 p-3 text-sm font-semibold text-gray-500" data-tab="interviews">Interviews (${interviews.length})</button>
                    </div>
                    <div id="saved-jobs-tab" class="my-jobs-tab-content active space-y-4"></div>
                    <div id="applied-jobs-tab" class="my-jobs-tab-content space-y-4" style="display:none;"></div>
                    <div id="interviews-jobs-tab" class="my-jobs-tab-content space-y-4" style="display:none;"></div>
                </div>
            `;

        renderTrackedJobs(savedJobs, "saved-jobs-tab", "saved");
        renderTrackedJobs(appliedJobs, "applied-jobs-tab", "applied");
        renderTrackedJobs(interviews, "interviews-jobs-tab", "interview");

        document.querySelectorAll(".my-jobs-tab-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            const tabId = e.target.dataset.tab;
            document.querySelectorAll(".my-jobs-tab-item").forEach((t) => {
              t.classList.remove("active");
              t.classList.add("text-gray-500");
            });
            e.target.classList.add("active");
            e.target.classList.remove("text-gray-500");
            document
              .querySelectorAll(".my-jobs-tab-content")
              .forEach((c) => (c.style.display = "none"));
            document.getElementById(`${tabId}-jobs-tab`).style.display =
              "block";
          });
        });
      }

      function renderTrackedJobs(jobs, containerId, statusType) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = jobs.length
          ? ""
          : '<p class="text-center text-gray-500 py-10">No jobs in this category yet.</p>';
        jobs.forEach((job) => {
          let statusHTML = "";
          switch (statusType) {
            case "applied":
              statusHTML = `<p class="text-sm text-blue-600 font-semibold flex items-center"><i class="fas fa-paper-plane text-blue-500 mr-2"></i>Status: Applied</p>`;
              break;
            case "interview":
              statusHTML = `<p class="text-sm text-green-600 font-bold flex items-center"><i class="fas fa-calendar-check text-green-500 mr-2"></i>Status: Interview Scheduled</p>`;
              break;
            case "saved":
              statusHTML = `<p class="text-sm text-gray-500 font-semibold flex items-center"><i class="fas fa-clock text-gray-400 mr-2"></i>Saved</p>`;
              break;
          }

          const jobCard = document.createElement("div");
          jobCard.className =
            "p-4 border rounded-lg bg-white shadow-sm cursor-pointer hover:shadow-md transition-all duration-300";
          jobCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-secondary">${job.title}</h3>
                            <p class="font-semibold text-gray-700">${job.company}</p>
                            <p class="text-sm text-gray-500 mb-2">${job.location}</p>
                        </div>
                        <i class="fas fa-ellipsis-v text-gray-400"></i>
                    </div>
                    <div class="mt-3 pt-3 border-t">
                        ${statusHTML}
                    </div>
                `;
          jobCard.addEventListener("click", () => openJobDetailsModal(job.id));
          container.appendChild(jobCard);
        });
      }

      function renderMessagesContent() {
        const wrapper = document.getElementById("messages-content-wrapper");
        if (!wrapper) return;

        let messagesHTML = conversations
          .map(
            (convo) => `
                <div class="p-4 border rounded-lg bg-white shadow-sm cursor-pointer hover:shadow-md transition-shadow mb-3" onclick="openChatView(${
                  convo.id
                })">
                    <div class="flex justify-between items-center">
                        <p class="font-bold text-gray-800">${convo.company}</p>
                        ${
                          convo.unread
                            ? '<span class="w-3 h-3 bg-secondary rounded-full"></span>'
                            : ""
                        }
                    </div>
                    <p class="font-semibold text-gray-700">${convo.jobTitle}</p>
                    <p class="text-sm text-gray-500 truncate">${
                      convo.chat[convo.chat.length - 1].text
                    }</p>
                </div>
            `
          )
          .join("");

        wrapper.innerHTML = `
                <header class="sticky top-0 bg-white z-10 pt-4 -mx-4 px-4 pb-3 border-b"><h1 class="text-2xl font-bold text-primary">Messages</h1></header>
                <div class="pt-4" id="message-list">
                    ${messagesHTML}
                </div>
            `;
      }

      function openChatView(conversationId) {
        const mainContent = document.getElementById("main-content");
        const conversation = conversations.find((c) => c.id === conversationId);
        if (!conversation) return;

        conversation.unread = false;

        let chatHTML = "";
        let lastSender = null;

        conversation.chat.forEach((msg) => {
          const showHeader = msg.sender !== lastSender;
          lastSender = msg.sender;

          if (msg.sender === "company") {
            chatHTML += `
                            <div class="flex justify-start items-start mb-4">
                                <div class="bg-gray-200 p-3 rounded-lg max-w-[80%]">
                                    <p class="text-sm text-gray-800 break-words">${msg.text}</p>
                                    <p class="text-xs text-gray-500 text-right mt-1">${msg.timestamp}</p>
                                </div>
                            </div>
                        `;
          } else {
            // sender is 'user'
            const tickClass = msg.status === "read" ? "read" : "";
            const tickIcon =
              msg.status === "sent" ? "fa-check" : "fa-check-double";
            chatHTML += `
                            <div class="flex justify-end items-start mb-4">
                                 <div class="bg-secondary text-white p-3 rounded-lg max-w-[80%]">
                                    <p class="text-sm break-words">${msg.text}</p>
                                    <div class="flex justify-end items-center mt-1">
                                        <p class="text-xs text-teal-200 mr-2">${msg.timestamp}</p>
                                        <i class="fas ${tickIcon} ticks ${tickClass}"></i>
                                    </div>
                                </div>
                            </div>
                        `;
          }
        });

        mainContent.innerHTML = `
                <div id="chat-view-container" class="flex flex-col h-full">
                    <!-- Header -->
                    <div class="flex items-center p-3 border-b sticky top-0 bg-white z-10 -mx-4 px-4">
                        <button onclick="navigateTo('messages-page')" class="p-2 mr-2"><i class="fas fa-arrow-left text-xl"></i></button>
                        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white font-bold mr-3 flex-shrink-0">${conversation.company.charAt(
                          0
                        )}</div>
                        <div>
                            <h2 class="font-bold text-gray-800">${
                              conversation.company
                            }</h2>
                            <p class="text-sm text-gray-500">${
                              conversation.jobTitle
                            }</p>
                        </div>
                    </div>

                    <!-- Chat Body -->
                    <div id="chat-body" class="flex-grow p-4 overflow-y-auto pb-20">
                        ${chatHTML}
                    </div>

                    <!-- Message Input -->
                    <div class="fixed bottom-14 left-0 right-0 max-w-md mx-auto p-2 bg-white border-t">
                        <form id="message-form" class="flex items-center bg-gray-100 rounded-full px-2">
                            <button type="button" class="p-3 text-gray-500"><i class="fas fa-plus text-xl"></i></button>
                            <input type="text" id="message-input" placeholder="Write a message..." class="w-full p-2 bg-transparent focus:outline-none" autocomplete="off">
                            <button type="submit" class="p-3 text-secondary font-bold rounded-full"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            `;

        const chatBody = document.getElementById("chat-body");
        chatBody.scrollTop = chatBody.scrollHeight;

        document
          .getElementById("message-form")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            sendMessage(conversationId);
          });
      }

      function sendMessage(conversationId) {
        const input = document.getElementById("message-input");
        const text = input.value.trim();
        if (text === "") return;

        const conversation = conversations.find((c) => c.id === conversationId);
        if (!conversation) return;

        const now = new Date();
        const timestamp = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        conversation.chat.push({
          sender: "user",
          text: text,
          timestamp: timestamp,
          status: "sent", // Start with 'sent' status
        });

        input.value = "";
        openChatView(conversationId);

        // Simulate delivered and read receipts
        const lastUserMessageIndex = conversation.chat.length - 1;
        setTimeout(() => {
          conversation.chat[lastUserMessageIndex].status = "delivered";
          openChatView(conversationId);
        }, 1500);
        setTimeout(() => {
          conversation.chat[lastUserMessageIndex].status = "read";
          openChatView(conversationId);
        }, 3000);
      }
      
      // --- EASY APPLY & PREMIUM FLOW ---
      function openEasyApplyModal(jobId, step = 1) {
          const job = allJobs.find(j => j.id === jobId);
          if (!job) return;

          let modalTitle = "";
          let modalContent = "";
          let onNext = null;

          switch(step) {
              case 1:
                  modalTitle = `Apply to ${job.company}`;
                  modalContent = getEasyApplyStep1HTML(jobId);
                  onNext = () => openEasyApplyModal(jobId, 2);
                  break;
              case 2:
                  modalTitle = `Pre-Interview Questions`;
                  modalContent = getEasyApplyStep2HTML(jobId);
                  onNext = () => openEasyApplyModal(jobId, 3);
                  break;
              case 3:
                  modalTitle = `Review Your Application`;
                  modalContent = getEasyApplyStep3HTML(jobId);
                  onNext = () => handleEasyApplySubmit(jobId);
                  break;
          }

          const fullModalHTML = `
              ${modalContent}
              <div class="flex justify-between items-center mt-6">
                  <p class="text-sm text-gray-500 font-semibold">Step ${step} of 3</p>
                  <button id="easy-apply-next-btn" class="btn-primary font-bold py-2 px-6 rounded-lg">${step === 3 ? 'Submit Application' : 'Next'}</button>
              </div>
          `;
          
          openModal(modalTitle, fullModalHTML);
          
          if (step === 1) {
              document.getElementById('easy-apply-resume-input').addEventListener('change', (e) => handleFileSelect(e.target.files, true, jobId));
          }

          document.getElementById('easy-apply-next-btn').addEventListener('click', onNext);
      }

      function getEasyApplyStep1HTML(jobId) {
          const resumeName = userResume.fileName ? userResume.fileName : "No resume uploaded";
          return `
              <div>
                  <h3 class="font-semibold text-lg mb-2">Your Resume</h3>
                  <p class="text-sm text-gray-600 mb-4">Your saved resume will be sent with your application. You can upload a different one for this job.</p>
                  <div class="bg-gray-100 p-3 rounded-lg flex justify-between items-center">
                      <div>
                          <i class="fas fa-file-alt text-gray-500 mr-2"></i>
                          <span id="easy-apply-current-resume">${resumeName}</span>
                      </div>
                      <label for="easy-apply-resume-input" class="text-sm text-secondary font-semibold cursor-pointer">Change</label>
                      <input type="file" id="easy-apply-resume-input" class="hidden">
                  </div>
                  <p id="easy-apply-file-info" class="text-xs text-gray-500 mt-1">You can upload a new PDF or DOCX file.</p>
                  <p id="easy-apply-file-name" class="text-sm text-green-600 font-semibold mt-1 hidden"></p>
              </div>
          `;
      }

      function getEasyApplyStep2HTML(jobId) {
          return `
              <div>
                  <p class="text-sm text-gray-600 mb-4">Please answer a few questions from the employer.</p>
                  <div class="space-y-4">
                      <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Why are you a good fit for this role?</label>
                          <textarea class="w-full p-2 border rounded-md" rows="3"></textarea>
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">What is your notice period? (in days)</label>
                          <input type="number" class="w-full p-2 border rounded-md" value="0">
                      </div>
                  </div>
              </div>
          `;
      }

      function getEasyApplyStep3HTML(jobId) {
          const job = allJobs.find(j => j.id === jobId);
          return `
              <div>
                  <p class="text-sm text-gray-600 mb-4">Please review your application details before submitting.</p>
                  <div class="bg-gray-50 p-4 rounded-lg space-y-2">
                      <p><strong>Applying for:</strong> ${job.title} at ${job.company}</p>
                      <p><strong>Your Name:</strong> ${currentUser.name}</p>
                      <p><strong>Your Email:</strong> ${currentUser.email}</p>
                      <p><strong>Resume:</strong> ${userResume.fileName || 'Default Resume'}</p>
                  </div>
              </div>
          `;
      }
      
      function handleEasyApplySubmit(jobId) {
          if (!userAppliedJobs.includes(jobId)) {
              userAppliedJobs.push(jobId);
          }
          closeModal();
          openModal("Application Sent!", `
              <div class="text-center py-4">
                  <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                  <p class="text-lg font-semibold text-gray-800">Your application for the ${allJobs.find(j=>j.id === jobId).title} role has been successfully submitted.</p>
                  <p class="text-gray-600 mt-2">You can track its status in the 'My Jobs' section.</p>
              </div>
          `);
      }

      function getPremiumPageHTML() {
        return `
            <header class="sticky top-0 bg-white z-10 p-4 border-b flex items-center">
                <button onclick="navigateTo('profile-page')" class="p-2 mr-2 -ml-2"><i class="fas fa-arrow-left text-xl"></i></button>
                <h1 class="text-2xl font-bold text-primary">Upgrade to Premium</h1>
            </header>
            <div class="p-4">
                <div class="text-center mb-6">
                    <i class="fas fa-rocket text-5xl text-yellow-400 mb-3"></i>
                    <h2 class="text-2xl font-bold text-gray-800">Unlock Your Full Potential</h2>
                    <p class="text-gray-600 mt-1">Get exclusive access to features that help you land your dream job faster.</p>
                </div>

                <div class="space-y-4 mb-6">
                    <div id="plan-yearly" class="plan-card p-4 rounded-lg cursor-pointer relative">
                        <span class="absolute top-0 right-4 -mt-3 bg-yellow-400 text-white text-xs font-bold px-3 py-1 rounded-full">BEST VALUE</span>
                        <h3 class="text-xl font-bold">Yearly Plan</h3>
                        <p class="text-2xl font-bold text-secondary">₹1,999 <span class="text-base font-normal text-gray-500">/year</span></p>
                        <p class="text-sm text-gray-500">Billed once a year. Save 58%!</p>
                    </div>
                    <div id="plan-monthly" class="plan-card p-4 rounded-lg cursor-pointer">
                        <h3 class="text-xl font-bold">Monthly Plan</h3>
                        <p class="text-2xl font-bold text-secondary">₹399 <span class="text-base font-normal text-gray-500">/month</span></p>
                        <p class="text-sm text-gray-500">Billed monthly, cancel anytime.</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h4 class="font-semibold text-lg mb-3">Premium Benefits:</h4>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>Unlimited AI Resume Reviews</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>See Who Viewed Your Profile</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>Stand Out with a Premium Badge</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>Advanced Interview Preparation</li>
                        <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-3"></i>Ad-free Experience</li>
                    </ul>
                </div>

                <button id="choose-plan-btn" class="w-full btn-primary font-bold py-3 rounded-lg" disabled>Choose Plan</button>
            </div>
        `;
      }

      function setupPremiumPageListeners() {
          const yearlyCard = document.getElementById('plan-yearly');
          const monthlyCard = document.getElementById('plan-monthly');
          const chooseBtn = document.getElementById('choose-plan-btn');
          let selectedPlan = null;

          yearlyCard.addEventListener('click', () => {
              yearlyCard.classList.add('selected');
              monthlyCard.classList.remove('selected');
              selectedPlan = 'yearly';
              chooseBtn.disabled = false;
          });

          monthlyCard.addEventListener('click', () => {
              monthlyCard.classList.add('selected');
              yearlyCard.classList.remove('selected');
              selectedPlan = 'monthly';
              chooseBtn.disabled = false;
          });

          chooseBtn.addEventListener('click', () => {
              if (selectedPlan) {
                  navigateToPayment(selectedPlan);
              }
          });
      }

      function navigateToPayment(planType) {
          navigateTo('payment-page');
          renderPaymentGateway(planType);
      }

      function renderPaymentGateway(planType) {
          const wrapper = document.getElementById('payment-gateway-wrapper');
          if (!wrapper) return;

          const plans = {
              monthly: { name: "Monthly Plan", price: "₹399.00" },
              yearly: { name: "Yearly Plan", price: "₹1,999.00" }
          };
          const selectedPlan = plans[planType];

          wrapper.innerHTML = `
              <header class="sticky top-0 bg-white z-10 p-4 border-b flex items-center">
                  <button onclick="navigateTo('premium-page')" class="p-2 mr-2 -ml-2"><i class="fas fa-arrow-left text-xl"></i></button>
                  <h1 class="text-2xl font-bold text-primary">Complete Payment</h1>
              </header>
              <div class="p-4">
                  <div class="bg-gray-100 p-4 rounded-lg mb-6">
                      <div class="flex justify-between items-center">
                          <span class="font-semibold text-gray-700">${selectedPlan.name}</span>
                          <span class="font-bold text-gray-800">${selectedPlan.price}</span>
                      </div>
                      <p class="text-sm text-gray-500 mt-1">You are about to make a one-time payment.</p>
                  </div>

                  <div class="flex bg-gray-200 rounded-lg p-1 mb-6">
                      <button data-tab="upi" class="payment-tab active flex-1 p-2 rounded-md font-semibold text-sm">UPI</button>
                      <button data-tab="card" class="payment-tab flex-1 p-2 rounded-md font-semibold text-sm">Debit/Credit Card</button>
                  </div>

                  <div id="upi-payment" class="payment-tab-content active">
                      <div class="space-y-3">
                          <button onclick="showPaymentSuccess()" class="w-full text-left flex items-center p-3 border rounded-lg hover:bg-gray-50"><img src="https://placehold.co/40x40/FFFFFF/000000?text=GPay" class="w-10 h-10 mr-4 rounded-md"><span class="font-semibold">GPay</span></button>
                          <button onclick="showPaymentSuccess()" class="w-full text-left flex items-center p-3 border rounded-lg hover:bg-gray-50"><img src="https://placehold.co/40x40/FFFFFF/000000?text=Paytm" class="w-10 h-10 mr-4 rounded-md"><span class="font-semibold">Paytm</span></button>
                          <button onclick="showPaymentSuccess()" class="w-full text-left flex items-center p-3 border rounded-lg hover:bg-gray-50"><img src="https://placehold.co/40x40/FFFFFF/000000?text=APay" class="w-10 h-10 mr-4 rounded-md"><span class="font-semibold">Amazon Pay</span></button>
                      </div>
                  </div>

                  <div id="card-payment" class="payment-tab-content" style="display:none;">
                      <form id="card-payment-form" class="space-y-4">
                          <div>
                              <label class="block text-sm font-medium text-gray-700">Card Number</label>
                              <input type="text" placeholder="•••• •••• •••• ••••" class="mt-1 w-full p-3 border rounded-lg">
                          </div>
                          <div class="flex space-x-4">
                              <div class="flex-1">
                                  <label class="block text-sm font-medium text-gray-700">Expiry Date</label>
                                  <input type="text" placeholder="MM / YY" class="mt-1 w-full p-3 border rounded-lg">
                              </div>
                              <div class="flex-1">
                                  <label class="block text-sm font-medium text-gray-700">CVV</label>
                                  <input type="text" placeholder="•••" class="mt-1 w-full p-3 border rounded-lg">
                              </div>
                          </div>
                          <div>
                              <label class="block text-sm font-medium text-gray-700">Name on Card</label>
                              <input type="text" placeholder="Rohan Sharma" class="mt-1 w-full p-3 border rounded-lg">
                          </div>
                          <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg mt-4">Pay ${selectedPlan.price}</button>
                      </form>
                  </div>
              </div>
          `;

          document.querySelectorAll('.payment-tab').forEach(tab => {
              tab.addEventListener('click', () => {
                  document.querySelectorAll('.payment-tab').forEach(t => t.classList.remove('active'));
                  tab.classList.add('active');
                  document.querySelectorAll('.payment-tab-content').forEach(c => c.style.display = 'none');
                  document.getElementById(`${tab.dataset.tab}-payment`).style.display = 'block';
              });
          });

          document.getElementById('card-payment-form').addEventListener('submit', (e) => {
              e.preventDefault();
              showPaymentSuccess();
          });
      }

      function showPaymentSuccess() {
          closeModal();
          openModal("Payment Successful!", `
              <div class="text-center py-4">
                  <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                  <p class="text-xl font-semibold text-gray-800">Welcome to Berozgaars Premium!</p>
                  <p class="text-gray-600 mt-2">Your new features are now active. Enjoy the ad-free experience and advanced tools!</p>
                  <button onclick="navigateTo('profile-page')" class="btn-primary font-bold py-2 px-6 rounded-lg mt-6">Go to Profile</button>
              </div>
          `);
          currentUser.isPremium = true;
          localStorage.setItem("currentUser", JSON.stringify(currentUser));
      }

    </script>
  </body>
</html>
